<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MediMimes</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
/* ---------------------------------------
   Medical UI THEME ‚Äî Clean & Clinical
----------------------------------------*/
:root {
    --color-primary-bg: #ffffff;        /* PURE WHITE */
    --color-secondary-bg: #f5f9fc;      /* very light medical blue */
    --color-accent: #0ea5e9;            /* medical teal-blue */
    --color-accent-dark: #0284c7;       /* darker teal for hover */
    --color-text-dark: #1e293b;         /* slate text */
    --color-text-muted: #64748b;        /* muted slate */
    --color-border: #dce7f1;            /* soft blue border */
}

/* GLOBAL */
body {
    font-family: 'Inter', sans-serif;
    background: var(--color-primary-bg);
    color: var(--color-text-dark);
    height: 100vh;
    display: flex;
    flex-direction: column;
    margin: 0;
}

/* NAVBAR */
.navbar {
    background: var(--color-secondary-bg) !important;
    border-bottom: 1px solid var(--color-border);
}
.navbar-brand {
    color: var(--color-accent) !important;
    font-weight: 700;
}
.btn-outline-light {
    color: var(--color-text-dark);
    border-color: var(--color-border);
}
.btn-outline-light:hover {
    background: var(--color-accent);
    color: #fff;
}

/* INTRO TEXT */
#introSection h4 {
    color: var(--color-text-dark);
}
#introSection p {
    color: var(--color-text-muted);
}

/* CARDS - medical clean style */
.card {
    background: #ffffff;
    border: 1px solid var(--color-border);
    color: var(--color-text-dark);
    transition: 0.2s ease;
    border-radius: 10px;
}
.card:hover {
    transform: translateY(-3px);
    border-color: var(--color-accent);
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    cursor: pointer;
}

/* CHAT AREA */
.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px 80px;
}

/* USER MESSAGE */
.chat-bubble-user {
    background: var(--color-accent);
    padding: 12px 16px;
    border-radius: 14px 14px 2px 14px;
    max-width: 45%;
    margin-left: auto;
    margin-bottom: 12px;
    color: #fff;
}

/* BOT MESSAGE */
.chat-bubble-bot {
    background: var(--color-secondary-bg);
    padding: 12px 16px;
    border-radius: 14px 14px 14px 2px;
    max-width: 55%;
    margin-right: auto;
    margin-bottom: 12px;
    border: 1px solid var(--color-border);
    color: var(--color-text-dark);
}

/* INPUT BAR */
#chatInputBar {
    position: sticky;
    bottom: 0;
    background: #ffffff;
    padding: 12px 0;
    border-top: 1px solid var(--color-border);
}

/* INPUT FIELD */
.form-control {
    background: #ffffff;
    border: 1px solid var(--color-border);
    color: var(--color-text-dark);
}
.form-control:focus {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 4px rgba(14,165,233,0.2);
    background: #ffffff;
}

/* MICROPHONE ICON AREA */
.input-group-text {
    background: var(--color-secondary-bg);
    border: 1px solid var(--color-border);
    border-right: none;
    color: var(--color-text-muted);
}
.input-group-text:hover {
    color: var(--color-accent);
}

/* PRIMARY BUTTON */
.btn-primary {
    background-color: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
    font-weight: 600;
}
.btn-primary:hover {
    background-color: var(--color-accent-dark) !important;
}
</style>
</head>

<body>

<nav class="navbar navbar-light px-3 shadow-sm">
    <a class="navbar-brand" href="{% url 'dashboard' %}">
                <span class="brand-badge"><i class="fas fa-prescription-bottle"></i></span>
                <div>
                    <div style="font-weight:800;">MediMimes</div>
                    <small style="color:var(--muted); font-weight:600;">Medication Companion</small>
                </div>
            </a>
    <button id="newChatBtn" class="btn btn-outline-light btn-sm">
        ‚ú® New Chat
    </button>
</nav>

<div id="introSection" class="text-center mt-4">
    <h4 class="fw-bold">Hello! I'm your MediMimes AI Assistant</h4>
    <p class="text-muted">Ask anything about symptoms, medications, adherence or general health.</p>

    <div class="container">
        <div class="row g-3 justify-content-center">
            <div class="col-5">
                <div class="card p-3 action-card text-center" data-prompt="What is ibuprofen used for?">üíä What is ibuprofen used for?</div>
            </div>
            <div class="col-5">
                <div class="card p-3 action-card text-center" data-prompt="Log my headache symptoms">ü©∫ Log my headache symptoms</div>
            </div>
            <div class="col-5">
                <div class="card p-3 action-card text-center" data-prompt="Did I miss any dose today?">‚è± What is my medication shedule for today?</div>
            </div>
            <div class="col-5">
                <div class="card p-3 action-card text-center" data-prompt="Explain diabetes simply">üìò What are effects of irregular BP?</div>
            </div>
        </div>
    </div>
</div>

<div id="chatArea" class="chat-container"></div>

<div id="chatInputBar" class="container">
    <div class="input-group">
        <input type="text" id="userInput" class="form-control" placeholder="Ask anything..." />
        <span class="input-group-text p-0" id="micButton" role="button" title="Voice input coming soon">
            <i class="bi bi-mic fs-4 p-2"></i>
        </span>
        <button class="btn btn-primary" id="sendBtn" title="Send message">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>

<script>
/* ------------------------------
   CSRF HANDLING
------------------------------ */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

const chatArea = document.getElementById("chatArea");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const introSection = document.getElementById("introSection");
const newChatBtn = document.getElementById("newChatBtn");

let conversationHistory = [];
const MAX_MEMORY = 6;

function addBotMessage(text) {
    const bubble = document.createElement("div");
    bubble.className = "chat-bubble-bot";
    bubble.innerText = text;
    chatArea.appendChild(bubble);
    chatArea.scrollTop = chatArea.scrollHeight;
}

function addUserMessage(text) {
    const bubble = document.createElement("div");
    bubble.className = "chat-bubble-user";
    bubble.innerText = text;
    chatArea.appendChild(bubble);
    chatArea.scrollTop = chatArea.scrollHeight;
}

function truncateMemory() {
    if (conversationHistory.length > MAX_MEMORY) {
        conversationHistory = conversationHistory.slice(-MAX_MEMORY);
    }
}

async function sendMessage(message) {
    if (!message.trim()) return;
    introSection.style.display = "none";

    addUserMessage(message);
    conversationHistory.push({ user: message });
    truncateMemory();

    addBotMessage("Thinking...");

    const payload = {
        message: message,
        user_id: window.USER_ID,
        context: { history: conversationHistory }
    };

    try {
        const res = await fetch("/chat/", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify(payload),
        });

        const data = await res.json();

        chatArea.removeChild(chatArea.lastChild);
        addBotMessage(data.response || "Something went wrong.");
        conversationHistory.push({ bot: data.response });
        truncateMemory();

    } catch (error) {
        console.error("Chat error:", error);
        if (chatArea.lastChild && chatArea.lastChild.innerText === "Thinking...") {
            chatArea.removeChild(chatArea.lastChild);
        }
        addBotMessage("Error: Could not reach server. Please check your connection.");
    }
}

sendBtn.onclick = () => {
    sendMessage(userInput.value);
    userInput.value = "";
};

userInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
        e.preventDefault();
        sendBtn.click();
    }
});

document.querySelectorAll(".action-card").forEach(card => {
    card.onclick = () => sendMessage(card.dataset.prompt);
});

newChatBtn.onclick = () => {
    conversationHistory = [];
    chatArea.innerHTML = "";
    introSection.style.display = "block";
};

document.getElementById("micButton").onclick = () => {
    alert("üé§ Voice input coming soon!");
};

const USER_ID = "{{ request.user.id }}";
</script>

</body>
</html>