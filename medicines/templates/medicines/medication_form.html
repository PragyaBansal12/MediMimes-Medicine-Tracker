{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% if med %}Edit{% else %}Add{% endif %} Medication - HealthConnect</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ---------- Design tokens (Clean Medical Theme) ---------- */
        :root{
            --bg: #f7fafc;              /* very light gray */
            --card-bg: #ffffff;          /* white cards */
            --primary: #0d6efd;          /* bootstrap primary (blue) */
            --teal: #0bb5a3;             /* calm teal accent */
            --muted: #6c757d;            /* muted text */
            --success: #198754;
            --radius: 14px;
            --glass-border: rgba(13,110,253,0.06);
            --shadow-1: 0 6px 18px rgba(18,52,84,0.06);
            --shadow-2: 0 1px 0 rgba(255,255,255,0.6) inset;
            font-family: "Inter", "Quicksand", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        html,body{
            height:100%;
            background: linear-gradient(180deg, var(--bg) 0%, #eef6fb 100%);
            color: #0b2447;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            padding: 3rem 1rem;
        }

        /* Form Container (Card) */
        .form-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-1);
            border: 1px solid var(--glass-border);
            max-width: 600px;
            margin: 0 auto;
            padding: 2.5rem;
        }

        /* Icon Circle */
        .icon-wrapper {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .icon-circle{
            width:64px; height:64px; border-radius:12px;
            display:inline-flex; align-items:center; justify-content:center;
            background: linear-gradient(180deg, rgba(13,110,253,0.08), rgba(11,181,163,0.04));
            border: 1px solid rgba(13,110,253,0.06);
            color: var(--primary); font-size:1.4rem;
        }

        /* Title */
        .welcome-title {
            color: #072338;
            font-weight: 700;
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .subtitle {
            color: var(--muted);
            margin-bottom: 1.5rem;
        }

        /* Form Controls */
        .form-label {
            font-weight: 600;
            color: #0b2447;
            margin-bottom: 0.4rem;
        }

        /* Clean Inputs - Replaces .form-control-magical */
        .form-control-clean{
            border:1px solid #e6eef7;
            border-radius: 12px;
            padding: .75rem 1rem;
            background: #fbfdff;
            transition: all .15s ease-in-out;
            color: #062335;
            box-shadow: var(--shadow-2);
        }
        .form-control-clean:focus{
            outline:none;
            box-shadow: 0 6px 18px rgba(13,110,253,0.08);
            border:1px solid rgba(13,110,253,0.25);
            transform: translateY(-1px);
        }
        
        /* Clean Select - Replaces .form-select-magical */
        .form-select-clean {
            border:1px solid #e6eef7;
            border-radius: 12px;
            padding: .75rem 1rem;
            background: #fbfdff;
            color: #062335;
            box-shadow: var(--shadow-2);
            /* Custom arrow for clean look */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5L8 11L14 5'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            appearance: none;
        }
        .form-select-clean:focus {
            outline:none;
            box-shadow: 0 6px 18px rgba(13,110,253,0.08);
            border:1px solid rgba(13,110,253,0.25);
            transform: translateY(-1px);
        }

        /* Primary/Success Button - Replaces .btn-success-magical and .btn-magical */
        .btn-primary-health{
            border-radius: 12px;
            background: linear-gradient(90deg, var(--teal) 0%, var(--primary) 100%);
            border: none;
            color: #fff;
            padding: .75rem 1.5rem;
            font-weight:700;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 8px 18px rgba(13,110,253,0.12);
        }
        .btn-primary-health:hover{
            transform: translateY(-2px);
            filter:brightness(1.04);
        }
        
        /* Secondary Button - Replaces .btn-secondary-magical */
        .btn-secondary-health {
            border-radius: 12px;
            background: #f8f9fa;
            border: 1px solid #e6eef7;
            color: #0b2447;
            padding: .75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.04);
        }
        .btn-secondary-health:hover {
            transform: translateY(-1px);
            background: #eef6fb;
        }

        /* Time Field Group */
        .time-field-group {
            background: #f8fafd; /* Lighter background for the time section */
            border: 1px solid #e6eef7;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .time-input {
            border: 1px solid #e6eef7;
            border-radius: 10px;
            padding: 0.6rem 0.8rem;
            transition: all 0.2s ease;
        }

        .time-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.2);
            transform: translateY(0);
        }

        .help-text {
            color: var(--muted);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <div class="text-center pt-2">
                <div class="icon-wrapper">
                    <div class="icon-circle" aria-hidden="true">
                        <i class="fas fa-pills"></i>
                    </div>
                </div>
                <h1 class="welcome-title fw-bold">
                    {% if med %}Edit{% else %}Add{% endif %} Medication
                </h1>
                <p class="subtitle">Set up your *Daily Dosage Schedule*.</p>
            </div>

            <div class="form-card p-0">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-tag me-2"></i>Medication Name
                        </label>
                        <input type="text" class="form-control-clean form-control" 
                               name="pill_name" value="{{ med.pill_name|default:'' }}" 
                               placeholder="e.g., Aspirin, Metformin" required>
                        <div class="help-text">What is the name of the medication?</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-balance-scale me-2"></i>Dosage (Units)
                        </label>
                        <input type="number" class="form-control-clean form-control" 
                               name="dosage" value="{{ med.dosage|default:'' }}" 
                               min="1" placeholder="e.g., 500 (mg)" required>
                        <div class="help-text">How many units should you take per dose?</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-sync-alt me-2"></i>Frequency Type
                        </label>
                        <select class="form-select-clean form-select" name="frequency_type" id="frequency_type">
                            <option value="DAILY" {% if not med or med.frequency_type == "DAILY" %}selected{% endif %}>
                                ðŸ“… Daily
                            </option>
                            <option value="WEEKLY" disabled>ðŸ“Š Weekly (coming soon)</option>
                            <option value="CUSTOM" disabled>âš¡ Custom (coming soon)</option>
                        </select>
                        <div class="help-text">How often do you need to take this medication?</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-clock me-2"></i>Doses per day
                        </label>
                        <input type="number" class="form-control-clean form-control" 
                               id="times_per_day" name="times_per_day" 
                               value="{% if med %}{{ med.times|length }}{% else %}1{% endif %}" 
                               min="1" max="5" required>
                        <div class="help-text">Set the number of doses per day (Max 5).</div>
                    </div>

                    <div class="time-field-group">
                        <label class="form-label">
                            <i class="fas fa-hourglass-half me-2"></i>Set Specific Times
                        </label>
                        <div id="time-fields" class="mt-3"></div>
                        <div class="help-text">Specify the exact time for each dose.</div>
                    </div>

                    <div class="text-center mt-5">
                        <button type="submit" class="btn btn-primary-health me-3" style="color: #000000;">
                            <i class="fas fa-save me-2" style="color: #000000;"></i>
                            {% if med %}Update Schedule{% else %}Save Medication{% endif %}
                        </button>

                        <a href="{% url 'med_list' %}" class="btn btn-secondary-health">
                            <i class="fas fa-arrow-left me-2"></i>Back to List
                        </a>
                    </div>

                </form>
            </div>
        </div>
    </div>

    {# CRITICAL FIX: Pass the existing times list safely as JSON #}
    <script src="{% static 'medicines/js/notifications.js' %}" defer></script>
    <script id="initial-times-data" type="application/json">
        {{ med.times|default:"[]"|safe }}
    </script>

    <script>
        // existing time data
        const initialTimesElement = document.getElementById('initial-times-data');
        let initialTimesData = []; 
        
        if (initialTimesElement) {
            const jsonText = initialTimesElement.textContent.trim();
            
            try {
                if (jsonText && jsonText !== '[]' && jsonText.startsWith('[')) {
                    initialTimesData = JSON.parse(jsonText);
                }
            } catch (e) {
                if (jsonText && jsonText.startsWith('[') && jsonText.endsWith(']')) {
                    initialTimesData = jsonText
                        .substring(1, jsonText.length - 1) 
                        .split(',')
                        .map(item => item.trim().replace(/['"]/g, '')) 
                        .filter(item => item.length > 0);
                }
            }
        }

        // saved data or current data 
        function renderTimeFields(count, currentValues = []) {
            const container = document.getElementById("time-fields");
            container.innerHTML = "";
            
            count = Math.min(5, Math.max(1, count));
            
            for (let i = 0; i < count; i++) {
                const div = document.createElement("div");
                div.className = "mb-3";
                
                const label = document.createElement("label");
                label.className = "form-label small";
                label.textContent = Time `${i + 1}`;
                
                const input = document.createElement("input");
                input.type = "time";
                input.name = "times";
                input.className = "form-control time-input"; // Using standard bootstrap class with .time-input override
                input.required = true;
                
                // Use temporary cached user input (if count was just changed)
                if (currentValues.length > i) {
                    input.value = currentValues[i];
                } 
                // Use permanent saved DB data (only on page load)
                else if (i < initialTimesData.length) {
                    input.value = initialTimesData[i];
                } else {
                    input.value = ""; 
                }
                
                div.appendChild(label);
                div.appendChild(input);
                container.appendChild(div);
            }
        }

        // Initial Render (on page load)
        const timesPerDayInput = document.getElementById("times_per_day");
        let initialCount = parseInt(timesPerDayInput.value) || 1;
        
        renderTimeFields(initialCount);

        // Re-render on manual change
        timesPerDayInput.addEventListener("change", function() {
            let newCount = parseInt(this.value) || 1;
            
            // Get all CURRENTLY entered time values BEFORE redrawing/clearing
            const currentInputs = document.querySelectorAll('#time-fields input[name="times"]');
            let currentTimes = Array.from(currentInputs).map(input => input.value);
            initialTimesData = []; 
            renderTimeFields(newCount, currentTimes);
        });

        // Add input validation
        timesPerDayInput.addEventListener('input', function() {
            let value = parseInt(this.value);
            if (value < 1) this.value = 1;
            if (value > 5) this.value = 5;
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>